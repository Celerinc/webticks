name: Publish to npm

# Trigger options - choose one or combine:
on:
  # Option 1: Manual trigger via GitHub UI
  workflow_dispatch:
    inputs:
      publish-all:
        description: 'Publish all packages'
        required: true
        type: boolean
        default: true
  
  # Option 2: Automatic on release creation
  release:
    types: [created]
  
  # Option 3: Automatic on version tag push (uncomment if needed)
  # push:
  #   tags:
  #     - 'v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write # Required for npm provenance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages (if needed)
        run: |
          # Build Angular package
          cd packages/angular
          if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
            pnpm build
          fi
          cd ../..
          
          # Build Nuxt package
          cd packages/nuxt
          if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
            pnpm build
          fi
          cd ../..
      
      - name: Publish @webticks/core
        run: |
          cd packages/core
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @webticks/node
        run: |
          cd packages/node
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @webticks/react
        run: |
          cd packages/react
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @webticks/angular
        run: |
          cd packages/angular
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @webticks/vue
        run: |
          cd packages/vue
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @webticks/next
        run: |
          cd packages/nextjs
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @webticks/sveltekit
        run: |
          cd packages/sveltekit
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish @webticks/nuxt
        run: |
          cd packages/nuxt
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Summary
        run: |
          echo "âœ… All packages published successfully!"
          echo "Published packages:"
          echo "- @webticks/core@$(node -p "require('./packages/core/package.json').version")"
          echo "- @webticks/node@$(node -p "require('./packages/node/package.json').version")"
          echo "- @webticks/react@$(node -p "require('./packages/react/package.json').version")"
          echo "- @webticks/angular@$(node -p "require('./packages/angular/package.json').version")"
          echo "- @webticks/vue@$(node -p "require('./packages/vue/package.json').version")"
          echo "- @webticks/next@$(node -p "require('./packages/nextjs/package.json').version")"
          echo "- @webticks/sveltekit@$(node -p "require('./packages/sveltekit/package.json').version")"
          echo "- @webticks/nuxt@$(node -p "require('./packages/nuxt/package.json').version")"
